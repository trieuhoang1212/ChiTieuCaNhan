<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Ti·∫øt Ki·ªám - Qu·∫£n l√Ω chi ti√™u</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="" name="keywords" />
    <meta content="" name="description" />

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon" />

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap"
      rel="stylesheet" />

    <!-- Icon Font Stylesheet -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
      rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
      rel="stylesheet" />

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet" />
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />
  </head>

  <body>
    <div class="container-xxl bg-white p-0">
      <!-- Spinner Start -->
      <div
        id="spinner"
        class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div
          class="spinner-border text-primary"
          style="width: 4rem; height: 4rem"
          role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
      <!-- Spinner End -->

      <!-- Navbar & Hero Start -->
      <div class="container-xxl position-relative p-0">
        <nav
          class="navbar navbar-expand-lg navbar-light px-4 px-lg-5 py-3 py-lg-0">
          <a href="index.html" class="navbar-brand p-0">
            <h1 class="m-0">MoneyCare</h1>
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarCollapse">
            <span class="fa fa-bars"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto py-0">
              <a href="index.html" class="nav-item nav-link">Chung</a>
              <a href="NapRut.html" class="nav-item nav-link">N·∫°p/R√∫t</a>
              <a href="ChiTieu.html" class="nav-item nav-link">Chi Ti√™u</a>
              <div class="nav-item dropdown">
                <a
                  href="#"
                  class="nav-link dropdown-toggle"
                  data-bs-toggle="dropdown"
                  >M·ª•c</a
                >
                <div class="dropdown-menu m-0">
                  <a href="TichLuy.html" class="dropdown-item">T√≠ch Lu·ªπ</a>
                  <a href="ThuChi.html" class="dropdown-item">Giao D·ªãch</a>
                  <a href="VayNo.html" class="dropdown-item">Vay N·ª£</a>
                  <a href="TietKiem.html" class="dropdown-item active"
                    >Ti·∫øt Ki·ªám</a
                  >
                </div>
              </div>
              <a href="Admin/template/index.html" class="nav-item nav-link"
                >Admin</a
              >
              <div class="nav-item dropdown" id="loginMenu">
                <a href="DangNhap.html" class="nav-item nav-link" id="loginLink"
                  >ƒêƒÉng Nh·∫≠p</a
                >
                <ul
                  class="dropdown-menu dropdown-menu-end"
                  aria-labelledby="loginLink"
                  id="userDropdown">
                  <li>
                    <a class="dropdown-item" href="ThongTin.html"
                      >üë§ Th√¥ng tin</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item"
                      href="index.html"
                      onclick="logout()"
                      >üö™ ƒêƒÉng xu·∫•t</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </nav>

        <div class="container-xxl bg-primary page-header">
          <div class="container text-center">
            <h1 class="text-white animated zoomIn mb-3">Ti·∫øt Ki·ªám</h1>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb justify-content-center">
                <li class="breadcrumb-item">
                  <a class="text-white" href="index.html">Chung</a>
                </li>
                <li class="breadcrumb-item">
                  <a class="text-white" href="#">Trang</a>
                </li>
                <li
                  class="breadcrumb-item text-white active"
                  aria-current="page">
                  Ti·∫øt Ki·ªám
                </li>
              </ol>
            </nav>
          </div>
        </div>
      </div>
      <!-- Navbar & Hero End -->

      <!-- Savings Plan Start -->
      <div class="container py-5">
        <h2 class="mb-4">S·ªï Ti·∫øt Ki·ªám</h2>

        <!-- Current Balance -->
        <div class="alert alert-info">
          üí∞ S·ªë d∆∞ hi·ªán c√≥: <strong id="currentBalance">0 VNƒê</strong>
        </div>

        <!-- Savings Form -->
        <div class="card mb-4">
          <div class="card-body">
            <form id="savingForm" class="row g-3">
              <div class="col-md-6">
                <label class="form-label">T√™n s·ªï</label>
                <input
                  type="text"
                  class="form-control"
                  name="savingName"
                  required />
              </div>
              <div class="col-md-6">
                <label class="form-label">S·ªë ti·ªÅn g·ª≠i (VNƒê)</label>
                <input
                  type="number"
                  class="form-control"
                  name="amount"
                  min="1000"
                  required />
              </div>
              <div class="col-md-6">
                <label class="form-label">K·ª≥ h·∫°n</label>
                <select
                  class="form-control"
                  id="termSelect"
                  name="term"
                  required>
                  <option value="0">Kh√¥ng k·ª≥ h·∫°n</option>
                  <option value="1">1 th√°ng</option>
                  <option value="3">3 th√°ng</option>
                  <option value="6">6 th√°ng</option>
                  <option value="12">12 th√°ng</option>
                  <option value="24">24 th√°ng</option>
                  <option value="36">36 th√°ng</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">L√£i su·∫•t/nƒÉm (%)</label>
                <input
                  type="number"
                  class="form-control"
                  name="interestRate"
                  id="interestRateInput"
                  readonly />
              </div>
              <div class="col-12">
                <input type="hidden" id="editSavingId" name="editSavingId" />
                <button type="submit" class="btn btn-success">
                  T·∫°o s·ªï ti·∫øt ki·ªám
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Savings List -->
        <h4 class="mb-3">Danh s√°ch s·ªï ti·∫øt ki·ªám</h4>
        <div id="savingsList" class="table-responsive">
          <!-- Table will be populated dynamically -->
        </div>
      </div>
      <!-- Savings Plan End -->

      <!-- Back to Top -->
      <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"
        ><i class="bi bi-arrow-up"></i
      ></a>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/wow/wow.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>

    <script>
      let savings = [];
      let balance = 0;

      // L·∫•y d·ªØ li·ªáu khi load
      document.addEventListener("DOMContentLoaded", () => {
        balance = Number(localStorage.getItem("balance")) || 0;
        document.getElementById("currentBalance").textContent =
          balance.toLocaleString() + " VNƒê";

        const savedSavings = localStorage.getItem("savings");
        if (savedSavings) savings = JSON.parse(savedSavings);

        renderSavings();
      });

      // T·ª± ƒë·ªông g√°n l√£i su·∫•t theo k·ª≥ h·∫°n
      document
        .getElementById("termSelect")
        .addEventListener("change", function () {
          const term = Number(this.value);
          let rate = 0;
          if (term === 0) rate = 0.3;
          else if (term >= 1 && term <= 12) rate = 4;
          else if (term >= 13 && term <= 36) rate = 6;

          document.getElementById("interestRateInput").value = rate;
        });

      // H√†m t√≠nh ng√†y k·∫øt th√∫c
      function getEndDate(startDate, termMonths) {
        const start = new Date(startDate);
        start.setMonth(start.getMonth() + termMonths);
        return start;
      }

      // H√†m t√≠nh s·ªë ng√†y c√≤n l·∫°i
      function getRemainingDays(endDate) {
        const today = new Date();
        const diffTime = endDate - today;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      }

      // H√†m t√≠nh l√£i d·ª± ki·∫øn
      function calculateInterest(amount, interestRate, startDate, term) {
        if (term === 0) {
          // kh√¥ng k·ª≥ h·∫°n ‚Üí t√≠nh l√£i 1 nƒÉm
          return amount * (interestRate / 100);
        } else {
          const startDate = new Date();
          const endDate = getEndDate(startDate, term);
          const days = getRemainingDays(endDate);
          if (days <= 0) return 0;
          return amount * (interestRate / 100) * (days / 365);
        }
      }

      // T·∫°o ho·∫∑c ch·ªânh s·ª≠a s·ªï ti·∫øt ki·ªám
      document
        .getElementById("savingForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const form = e.target;
          const savingName = form.savingName.value.trim();
          const amount = Number(form.amount.value);
          const term = Number(form.term.value);
          const interestRate = Number(form.interestRate.value);
          const editSavingId = form.editSavingId.value;
          const today = new Date().toISOString().split("T")[0];

          if (amount <= 0) {
            alert("‚ùå S·ªë ti·ªÅn g·ª≠i ph·∫£i l·ªõn h∆°n 0!");
            return;
          }

          if (!savingName) {
            alert("‚ùå Vui l√≤ng nh·∫≠p t√™n s·ªï ti·∫øt ki·ªám!");
            return;
          }

          if (editSavingId) {
            const idx = savings.findIndex((s) => s.id === Number(editSavingId));
            if (idx > -1) {
              balance += savings[idx].amount; // tr·∫£ l·∫°i s·ªë ti·ªÅn c≈©
              if (amount > balance) {
                alert("‚ùå S·ªë d∆∞ kh√¥ng ƒë·ªß ƒë·ªÉ g·ª≠i ti·∫øt ki·ªám!");
                balance -= savings[idx].amount; // ho√†n l·∫°i
                return;
              }
              savings[idx] = {
                id: Number(editSavingId),
                savingName,
                amount,
                term,
                interestRate,
                startDate: today,
              };
            }
          } else {
            if (amount > balance) {
              alert("‚ùå S·ªë d∆∞ kh√¥ng ƒë·ªß ƒë·ªÉ g·ª≠i ti·∫øt ki·ªám!");
              return;
            }
            savings.push({
              id: Date.now(),
              savingName,
              amount,
              term,
              interestRate,
              startDate: today,
            });
          }

          balance -= amount;
          localStorage.setItem("balance", balance);
          document.getElementById("currentBalance").textContent =
            balance.toLocaleString() + " VNƒê";
          localStorage.setItem("savings", JSON.stringify(savings));
          renderSavings();
          form.reset();
          form.editSavingId.value = "";
        });

      // X√≥a s·ªï ti·∫øt ki·ªám
      function deleteSaving(id) {
        const saving = savings.find((s) => s.id === id);
        if (!saving) return;
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·ªï ti·∫øt ki·ªám n√†y?")) {
          balance += saving.amount;
          localStorage.setItem("balance", balance);
          document.getElementById("currentBalance").textContent =
            balance.toLocaleString() + " VNƒê";

          savings = savings.filter((s) => s.id !== id);
          localStorage.setItem("savings", JSON.stringify(savings));
          renderSavings();
        }
      }

      // Hi·ªÉn th·ªã danh s√°ch s·ªï
      function renderSavings() {
        const container = document.getElementById("savingsList");
        container.innerHTML = "";

        if (savings.length === 0) {
          container.innerHTML = "<p>Ch∆∞a c√≥ s·ªï ti·∫øt ki·ªám n√†o.</p>";
          return;
        }

        savings.forEach((s) => {
          const endDate = getEndDate(s.startDate, s.term);
          const remainingDays = getRemainingDays(endDate);
          const interest = calculateInterest(
            s.amount,
            s.interestRate,
            s.startDate,
            s.term
          );

          const card = document.createElement("div");
          card.className = "card p-3 mb-3";
          card.innerHTML = `
            <h5>${s.savingName}</h5>
            <p><strong>S·ªë ti·ªÅn g·ª≠i:</strong> ${s.amount.toLocaleString()} VNƒê</p>
            <p><strong>K·ª≥ h·∫°n:</strong> ${s.term} th√°ng</p>
            <p><strong>L√£i su·∫•t:</strong> ${s.interestRate}%/nƒÉm</p>
            <p><strong>S·ªë ng√†y c√≤n l·∫°i:</strong> ${
              remainingDays > 0 ? remainingDays : 0
            } ng√†y</p>
            <p><strong>L√£i d·ª± ki·∫øn:</strong> ${interest.toLocaleString(
              undefined,
              { maximumFractionDigits: 0 }
            )} VNƒê</p>
            <button class="btn btn-danger btn-sm" onclick="deleteSaving(${
              s.id
            })">üóëÔ∏è X√≥a</button>
          `;
          container.appendChild(card);
        });
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Ti·∫øt Ki·ªám - Qu·∫£n l√Ω chi ti√™u</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="" name="keywords" />
    <meta content="" name="description" />

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon" />

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap"
      rel="stylesheet" />

    <!-- Icon Font Stylesheet -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
      rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
      rel="stylesheet" />

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet" />
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />
  </head>

  <body>
    <div class="container-xxl bg-white p-0">
      <!-- Spinner Start -->
      <div
        id="spinner"
        class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div
          class="spinner-border text-primary"
          style="width: 4rem; height: 4rem"
          role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
      <!-- Spinner End -->

      <!-- Navbar & Hero Start -->
      <div class="container-xxl position-relative p-0">
        <nav
          class="navbar navbar-expand-lg navbar-light px-4 px-lg-5 py-3 py-lg-0">
          <a href="index.html" class="navbar-brand p-0">
            <h1 class="m-0">MoneyCare</h1>
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarCollapse">
            <span class="fa fa-bars"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto py-0">
              <a href="index.html" class="nav-item nav-link">Chung</a>
              <a href="NapRut.html" class="nav-item nav-link">N·∫°p/R√∫t</a>
              <a href="ChiTieu.html" class="nav-item nav-link">Chi Ti√™u</a>
              <div class="nav-item dropdown">
                <a
                  href="#"
                  class="nav-link dropdown-toggle"
                  data-bs-toggle="dropdown"
                  >M·ª•c</a
                >
                <div class="dropdown-menu m-0">
                  <a href="TichLuy.html" class="dropdown-item">T√≠ch Lu·ªπ</a>
                  <a href="ThuChi.html" class="dropdown-item">Giao D·ªãch</a>
                  <a href="VayNo.html" class="dropdown-item">Vay N·ª£</a>
                  <a href="TietKiem.html" class="dropdown-item active"
                    >Ti·∫øt Ki·ªám</a
                  >
                </div>
              </div>
              <a href="Admin/template/index.html" class="nav-item nav-link"
                >Admin</a
              >
              <div class="nav-item dropdown" id="loginMenu">
                <a href="DangNhap.html" class="nav-item nav-link" id="loginLink"
                  >ƒêƒÉng Nh·∫≠p</a
                >
                <ul
                  class="dropdown-menu dropdown-menu-end"
                  aria-labelledby="loginLink"
                  id="userDropdown">
                  <li>
                    <a class="dropdown-item" href="ThongTin.html"
                      >üë§ Th√¥ng tin</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item"
                      href="index.html"
                      onclick="logout()"
                      >üö™ ƒêƒÉng xu·∫•t</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </nav>

        <div class="container-xxl bg-primary page-header">
          <div class="container text-center">
            <h1 class="text-white animated zoomIn mb-3">Ti·∫øt Ki·ªám</h1>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb justify-content-center">
                <li class="breadcrumb-item">
                  <a class="text-white" href="index.html">Chung</a>
                </li>
                <li class="breadcrumb-item">
                  <a class="text-white" href="#">Trang</a>
                </li>
                <li
                  class="breadcrumb-item text-white active"
                  aria-current="page">
                  Ti·∫øt Ki·ªám
                </li>
              </ol>
            </nav>
          </div>
        </div>
      </div>
      <!-- Navbar & Hero End -->

      <!-- Savings Plan Start -->
      <div class="container py-5">
        <h2 class="mb-4">S·ªï Ti·∫øt Ki·ªám</h2>

        <!-- Current Balance -->
        <div class="alert alert-info">
          üí∞ S·ªë d∆∞ hi·ªán c√≥: <strong id="currentBalance">0 VNƒê</strong>
        </div>

        <!-- Savings Form -->
        <div class="card mb-4">
          <div class="card-body">
            <form id="savingForm" class="row g-3">
              <div class="col-md-6">
                <label class="form-label">T√™n s·ªï</label>
                <input
                  type="text"
                  class="form-control"
                  name="savingName"
                  required />
              </div>
              <div class="col-md-6">
                <label class="form-label">S·ªë ti·ªÅn g·ª≠i (VNƒê)</label>
                <input
                  type="number"
                  class="form-control"
                  name="amount"
                  min="1000"
                  required />
              </div>
              <div class="col-md-6">
                <label class="form-label">K·ª≥ h·∫°n</label>
                <select
                  class="form-control"
                  id="termSelect"
                  name="term"
                  required>
                  <option value="0">Kh√¥ng k·ª≥ h·∫°n</option>
                  <option value="1">1 th√°ng</option>
                  <option value="3">3 th√°ng</option>
                  <option value="6">6 th√°ng</option>
                  <option value="12">12 th√°ng</option>
                  <option value="24">24 th√°ng</option>
                  <option value="36">36 th√°ng</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">L√£i su·∫•t/nƒÉm (%)</label>
                <input
                  type="number"
                  class="form-control"
                  name="interestRate"
                  id="interestRateInput"
                  readonly />
              </div>
              <div class="col-md-6">
                <label class="form-label">Ph∆∞∆°ng th·ª©c tr·∫£ l√£i</label>
                <select class="form-control" name="payoutMethod" id="payoutMethodSelect" required>
                  <option value="cuoi_ky" selected>Cu·ªëi k·ª≥</option>
                  <option value="hang_thang">H√†ng th√°ng</option>
                  <option value="hang_quy">H√†ng qu√Ω</option>
                </select>
              </div>
              <div class="col-12">
                <input type="hidden" id="editSavingId" name="editSavingId" />
                <button type="submit" class="btn btn-success">
                  T·∫°o s·ªï ti·∫øt ki·ªám
                </button>
              </div>
            </form>
            <div
              id="interestPreview"
              class="alert alert-secondary mt-3 small"
              role="alert"
              style="display: none"></div>
          </div>
        </div>

        <!-- Savings List -->
        <h4 class="mb-3">Danh s√°ch s·ªï ti·∫øt ki·ªám</h4>
        <div id="savingsList" class="table-responsive">
          <!-- Table will be populated dynamically -->
        </div>
      </div>
      <!-- Savings Plan End -->

      <!-- Back to Top -->
      <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"
        ><i class="bi bi-arrow-up"></i
      ></a>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/wow/wow.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>

    <script>
      let savings = [];
      let balance = 0;
      const DEFAULT_NON_TERM_RATE = 0.3; // %/nƒÉm - t·ªëi thi·ªÉu cho kh√¥ng k·ª≥ h·∫°n

      // Helpers
      function toVND(n) {
        return Number(n).toLocaleString() + " VNƒê";
      }

      function refreshBalance() {
        return fetch("PHP/naprut.php?balanceOnly=1")
          .then((r) => r.json())
          .then((data) => {
            if (data.success) {
              balance = Number(data.currentBalance) || 0;
              document.getElementById("currentBalance").textContent =
                toVND(balance);
            }
          });
      }

      function refreshSavings() {
        return fetch("PHP/tietkiem.php")
          .then((r) => r.json())
          .then((data) => {
            if (data.success) {
              savings = data.savings || [];
              renderSavings();
            }
          });
      }

      // L·∫•y d·ªØ li·ªáu khi load
      document.addEventListener("DOMContentLoaded", () => {
        Promise.all([refreshBalance(), refreshSavings()])
          .then(() => {
            // Thi·∫øt l·∫≠p l√£i su·∫•t m·∫∑c ƒë·ªãnh theo k·ª≥ h·∫°n hi·ªán t·∫°i
            const termEl = document.getElementById("termSelect");
            const rateEl = document.getElementById("interestRateInput");
            const term = Number(termEl.value);
            let rate = 0;
            if (term === 0) rate = DEFAULT_NON_TERM_RATE;
            else if (term >= 1 && term <= 12) rate = 4;
            else if (term >= 13 && term <= 36) rate = 6;
            rateEl.value = rate;
            updateInterestPreview();
          })
          .catch(console.error);
      });

      // T·ª± ƒë·ªông g√°n l√£i su·∫•t theo k·ª≥ h·∫°n
      document
        .getElementById("termSelect")
        .addEventListener("change", function () {
          const term = Number(this.value);
          let rate = 0;
          if (term === 0) rate = DEFAULT_NON_TERM_RATE;
          else if (term >= 1 && term <= 12) rate = 4;
          else if (term >= 13 && term <= 36) rate = 6;
          document.getElementById("interestRateInput").value = rate;
          updateInterestPreview();
        });

      // H√†m t√≠nh ng√†y k·∫øt th√∫c
      function getEndDate(startDate, termMonths) {
        const start = new Date(startDate);
        start.setMonth(start.getMonth() + termMonths);
        return start;
      }

      // H√†m t√≠nh s·ªë ng√†y c√≤n l·∫°i
      function getRemainingDays(endDate) {
        const today = new Date();
        const diffTime = endDate - today;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      }

      // H√†m t√≠nh l√£i d·ª± ki·∫øn (s·ª≠a l·ªói d√πng sai startDate)
      function calculateInterest(amount, interestRate, startDate, term) {
        const amt = Number(amount) || 0;
        const rate = Number(interestRate) || 0;
        if (term === 0) {
          // kh√¥ng k·ª≥ h·∫°n ‚Üí ∆∞·ªõc t√≠nh l√£i 1 nƒÉm
          return amt * (rate / 100);
        } else {
          const sDate = new Date(startDate);
          const eDate = getEndDate(sDate, term);
          const days = getRemainingDays(eDate);
          if (days <= 0) return 0;
          return amt * (rate / 100) * (days / 365);
        }
      }

      // H√†m t√≠nh l√£i theo s·ªë th√°ng: nh·∫≠p s·ªë ti·ªÅn, %/nƒÉm, s·ªë th√°ng, c√≥ g·ªôp l√£i hay kh√¥ng
      // Tr·∫£ v·ªÅ: { lai, tongTien, kieu, laiSuatThang, soThang }
      function tinhLaiTheoThang(soTien, laiSuatNam, soThang, gopLai = false) {
        const principal = Number(soTien) || 0;
        const annualRate = Number(laiSuatNam) || 0; // %/nƒÉm
        const months = Math.max(0, Number(soThang) || 0);
        const monthlyRate = annualRate / 100 / 12; // h·ªá s·ªë theo th√°ng

        if (principal <= 0 || annualRate < 0 || months === 0) {
          return {
            lai: 0,
            tongTien: principal,
            kieu: gopLai ? "gop_lai" : "khong_gop_lai",
            laiSuatThang: monthlyRate,
            soThang: months,
          };
        }

        let interest = 0;
        let total = principal;

        if (gopLai) {
          // L√£i k√©p theo th√°ng
          total = principal * Math.pow(1 + monthlyRate, months);
          interest = total - principal;
        } else {
          // L√£i ƒë∆°n theo th√°ng (quy ƒë·ªïi t·ª∑ l·ªá nƒÉm sang s·ªë th√°ng)
          interest = principal * (annualRate / 100) * (months / 12);
          total = principal + interest;
        }

        return {
          lai: interest,
          tongTien: total,
          kieu: gopLai ? "gop_lai" : "khong_gop_lai",
          laiSuatThang: monthlyRate,
          soThang: months,
        };
      }

      // L√£i kh√¥ng k·ª≥ h·∫°n: t√≠nh theo s·ªë ng√†y th·ª±c t·∫ø (actual/365)
      function tinhLaiKhongKyHan(
        soTien,
        laiSuatNam,
        startDate,
        denNgay = null
      ) {
        const principal = Number(soTien) || 0;
        const annualRate = Number(laiSuatNam) || 0;
        const start = new Date(startDate);
        const end = denNgay ? new Date(denNgay) : new Date();
        const ms = end - start;
        const days = Math.max(0, Math.floor(ms / (1000 * 60 * 60 * 24)));
        const interest = principal * (annualRate / 100) * (days / 365);
        return {
          lai: interest,
          soNgay: days,
          denNgay: end.toISOString().split("T")[0],
        };
      }

      // T·∫°o s·ªï ti·∫øt ki·ªám: R√∫t ti·ªÅn t·ª´ s·ªë d∆∞ (naprut.php) r·ªìi l∆∞u s·ªï (tietkiem.php)
      document
        .getElementById("savingForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const form = e.target;
          const savingName = form.savingName.value.trim();
          const amount = Number(form.amount.value);
          const term = Number(form.term.value);
          let interestRate = Number(form.interestRate.value);
          if (term === 0 && (!interestRate || interestRate <= 0)) interestRate = DEFAULT_NON_TERM_RATE;
          const today = new Date().toISOString().split("T")[0];

          if (!savingName) return alert("‚ùå Vui l√≤ng nh·∫≠p t√™n s·ªï ti·∫øt ki·ªám!");
          if (amount <= 0) return alert("‚ùå S·ªë ti·ªÅn g·ª≠i ph·∫£i l·ªõn h∆°n 0!");

          // C·∫≠p nh·∫≠t s·ªë d∆∞ m·ªõi nh·∫•t tr∆∞·ªõc khi ki·ªÉm tra
          await refreshBalance();
          if (amount > balance)
            return alert("‚ùå S·ªë d∆∞ kh√¥ng ƒë·ªß ƒë·ªÉ g·ª≠i ti·∫øt ki·ªám!");

          try {
            // 1) R√∫t ti·ªÅn kh·ªèi s·ªë d∆∞
            const withdrawRes = await fetch("PHP/naprut.php", {
              method: "POST",
              headers: {
                "Content-Type":
                  "application/x-www-form-urlencoded;charset=UTF-8",
              },
              body: new URLSearchParams({
                loai: "R√∫t",
                so_tien: String(amount),
                mo_ta: `G·ª≠i ti·∫øt ki·ªám: ${savingName}`,
              }),
            }).then((r) => r.json());

            if (!withdrawRes.success) {
              alert(
                "‚ùå Kh√¥ng th·ªÉ r√∫t ti·ªÅn: " +
                  (withdrawRes.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh")
              );
              return;
            }

            // 2) L∆∞u s·ªï ti·∫øt ki·ªám
            const payoutMethodEl = document.getElementById('payoutMethodSelect');
            const payoutMethod = payoutMethodEl ? payoutMethodEl.value : 'cuoi_ky';

            const saveRes = await fetch("PHP/tietkiem.php", {
              method: "POST",
              headers: {
                "Content-Type":
                  "application/x-www-form-urlencoded;charset=UTF-8",
              },
              body: new URLSearchParams({
                savingName,
                amount: String(amount),
                term: String(term),
                interestRate: String(interestRate),
                startDate: today,
                payoutMethod
              }),
            }).then((r) => r.json());

            if (!saveRes.success) {
              // Rollback: n·∫°p l·∫°i ti·ªÅn n·∫øu t·∫°o s·ªï th·∫•t b·∫°i
              await fetch("PHP/naprut.php", {
                method: "POST",
                headers: {
                  "Content-Type":
                    "application/x-www-form-urlencoded;charset=UTF-8",
                },
                body: new URLSearchParams({
                  loai: "N·∫°p",
                  so_tien: String(amount),
                  mo_ta: `Ho√†n ti·ªÅn do l·ªói t·∫°o s·ªï: ${savingName}`,
                }),
              });
              alert(
                "‚ùå Kh√¥ng th·ªÉ t·∫°o s·ªï ti·∫øt ki·ªám: " +
                  (saveRes.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh")
              );
              return;
            }

            // L√†m m·ªõi d·ªØ li·ªáu
            await Promise.all([refreshBalance(), refreshSavings()]);
            form.reset();
            document.getElementById("interestRateInput").value = "";
            alert("‚úÖ T·∫°o s·ªï ti·∫øt ki·ªám th√†nh c√¥ng!");
          } catch (err) {
            console.error(err);
            alert("‚ùå L·ªói k·∫øt n·ªëi m√°y ch·ªß.");
          }
        });

      // X√≥a s·ªï ti·∫øt ki·ªám: x√≥a DB r·ªìi n·∫°p l·∫°i ti·ªÅn v·ªÅ s·ªë d∆∞
      async function deleteSaving(id, amount, name) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·ªï ti·∫øt ki·ªám n√†y?")) return;
        try {
          // 1) X√≥a s·ªï
          const delRes = await fetch("PHP/tietkiem.php", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            },
            body: new URLSearchParams({ id: String(id) }),
          }).then((r) => r.json());

          if (!delRes.success) {
            alert(
              "‚ùå Kh√¥ng th·ªÉ x√≥a s·ªï: " + (delRes.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh")
            );
            return;
          }

          // 2) N·∫°p l·∫°i ti·ªÅn
          if (Number(amount) > 0) {
            await fetch("PHP/naprut.php", {
              method: "POST",
              headers: {
                "Content-Type":
                  "application/x-www-form-urlencoded;charset=UTF-8",
              },
              body: new URLSearchParams({
                loai: "N·∫°p",
                so_tien: String(amount),
                mo_ta: `T·∫•t to√°n s·ªï ti·∫øt ki·ªám: ${name || id}`,
              }),
            });
          }

          await Promise.all([refreshBalance(), refreshSavings()]);
        } catch (err) {
          console.error(err);
          alert("‚ùå L·ªói k·∫øt n·ªëi m√°y ch·ªß.");
        }
      }

      // Hi·ªÉn th·ªã danh s√°ch s·ªï
      function renderSavings() {
        const container = document.getElementById("savingsList");
        container.innerHTML = "";

        if (!savings || savings.length === 0) {
          container.innerHTML = "<p>Ch∆∞a c√≥ s·ªï ti·∫øt ki·ªám n√†o.</p>";
          return;
        }

        savings.forEach((s) => {
          const startDate = s.startDate;

          let endDate = null;
          let remainingDays = 0;
          let interest = 0;
          let extraRows = "";

          if (Number(s.term) === 0) {
            // Kh√¥ng k·ª≥ h·∫°n: t√≠nh theo s·ªë ng√†y th·ª±c t·∫ø ƒë·∫øn h√¥m nay
            const nkh = tinhLaiKhongKyHan(s.amount, s.interestRate, startDate);
            interest = nkh.lai;
            extraRows = `
              <p><strong>Ng√†y g·ª≠i:</strong> ${startDate}</p>
              <p><strong>K·ª≥ h·∫°n:</strong> Kh√¥ng k·ª≥ h·∫°n</p>
              <p><strong>S·ªë ng√†y ƒë√£ g·ª≠i:</strong> ${nkh.soNgay} ng√†y</p>
              <p><strong>L√£i ∆∞·ªõc t√≠nh ƒë·∫øn ${nkh.denNgay}:</strong> ${Number(
              interest
            ).toLocaleString(undefined, { maximumFractionDigits: 0 })} VNƒê</p>
            `;
          } else {
            // C√≥ k·ª≥ h·∫°n
            endDate =
              s.endDate ||
              getEndDate(startDate, s.term).toISOString().split("T")[0];
            remainingDays = getRemainingDays(new Date(endDate));
            interest = calculateInterest(
              s.amount,
              s.interestRate,
              startDate,
              s.term
            );
            extraRows = `
              <p><strong>Ng√†y g·ª≠i:</strong> ${startDate}</p>
              <p><strong>Ng√†y ƒë√°o h·∫°n:</strong> ${endDate}</p>
              <p><strong>S·ªë ng√†y c√≤n l·∫°i:</strong> ${
                remainingDays > 0 ? remainingDays : 0
              } ng√†y</p>
              <p><strong>L√£i d·ª± ki·∫øn:</strong> ${Number(
                interest
              ).toLocaleString(undefined, { maximumFractionDigits: 0 })} VNƒê</p>
            `;
          }

          const pm = s.payoutMethod || s.phuong_thuc_lai || 'cuoi_ky';
          const pmText = pm === 'hang_thang' ? 'H√†ng th√°ng' : pm === 'hang_quy' ? 'H√†ng qu√Ω' : 'Cu·ªëi k·ª≥';

          const card = document.createElement("div");
          card.className = "card p-3 mb-3";
          card.innerHTML = `
            <h5>${s.savingName}</h5>
            <p><strong>S·ªë ti·ªÅn g·ª≠i:</strong> ${Number(
              s.amount
            ).toLocaleString()} VNƒê</p>
            <p><strong>L√£i su·∫•t:</strong> ${s.interestRate}%/nƒÉm</p>
            <p><strong>Ph∆∞∆°ng th·ª©c tr·∫£ l√£i:</strong> ${pmText}</p>
            ${extraRows}
            <div class="d-flex gap-2 align-items-end flex-wrap">
              <div>
                <label class="form-label mb-1">R√∫t m·ªôt ph·∫ßn (VNƒê)</label>
                <input type="number" class="form-control form-control-sm" id="withdraw-${
                  s.id
                }" min="1" max="${s.amount}" placeholder="Nh·∫≠p s·ªë ti·ªÅn" />
              </div>
              <button class="btn btn-outline-primary btn-sm" id="btn-withdraw-${
                s.id
              }">üí∏ R√∫t</button>
              <button class="btn btn-danger btn-sm" id="btn-delete-${
                s.id
              }">üóëÔ∏è X√≥a</button>
            </div>
          `;
          container.appendChild(card);

          // S·ª± ki·ªán r√∫t m·ªôt ph·∫ßn
          document
            .getElementById(`btn-withdraw-${s.id}`)
            .addEventListener("click", async () => {
              const input = document.getElementById(`withdraw-${s.id}`);
              const val = Number(input.value);
              if (!val || val <= 0) return alert("Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá.");
              if (val > Number(s.amount))
                return alert("V∆∞·ª£t qu√° s·ªë ti·ªÅn trong s·ªï.");

              try {
                // R√∫t kh·ªèi s·ªï
                const res = await fetch("PHP/tietkiem.php", {
                  method: "POST",
                  headers: {
                    "Content-Type":
                      "application/x-www-form-urlencoded;charset=UTF-8",
                  },
                  body: new URLSearchParams({
                    action: "withdraw",
                    id: String(s.id),
                    withdrawAmount: String(val),
                  }),
                }).then((r) => r.json());

                if (!res.success) {
                  alert("Kh√¥ng th·ªÉ r√∫t: " + (res.message || "L·ªói"));
                  return;
                }

                // N·∫°p v·ªÅ s·ªë d∆∞
                await fetch("PHP/naprut.php", {
                  method: "POST",
                  headers: {
                    "Content-Type":
                      "application/x-www-form-urlencoded;charset=UTF-8",
                  },
                  body: new URLSearchParams({
                    loai: "N·∫°p",
                    so_tien: String(val),
                    mo_ta: `R√∫t t·ª´ s·ªï TK: ${s.savingName}`,
                  }),
                });

                await Promise.all([refreshBalance(), refreshSavings()]);
              } catch (e) {
                console.error(e);
                alert("L·ªói k·∫øt n·ªëi m√°y ch·ªß.");
              }
            });

          // S·ª± ki·ªán x√≥a
          document
            .getElementById(`btn-delete-${s.id}`)
            .addEventListener("click", () => {
              deleteSaving(s.id, s.amount, s.savingName);
            });
        });
      }

      // Hi·ªÉn th·ªã preview l√£i theo k·ª≥ h·∫°n khi ng∆∞·ªùi d√πng nh·∫≠p
      function updateInterestPreview() {
        const name = document.querySelector('[name="savingName"]').value.trim();
        const amount = Number(document.querySelector('[name="amount"]').value);
        const term = Number(document.querySelector('[name="term"]').value);
        const rate = Number(
          document.querySelector('[name="interestRate"]').value
        );
        const box = document.getElementById("interestPreview");
        if (!amount || !rate) {
          box.style.display = "none";
          return;
        }
        const kqDon = tinhLaiTheoThang(amount, rate, term, false);
        const kqGop = tinhLaiTheoThang(amount, rate, term, true);
        box.style.display = "";
        box.innerHTML = `
          <div><strong>∆Ø·ªõc t√≠nh l√£i ${term} th√°ng</strong>${
          name ? ` cho "${name}"` : ""
        }:</div>
          <div>- L√£i ƒë∆°n: <b>${Number(
            kqDon.lai
          ).toLocaleString()}</b> (T·ªïng: ${Number(
          kqDon.tongTien
        ).toLocaleString()} VNƒê)</div>
          <div>- L√£i k√©p: <b>${Number(
            kqGop.lai
          ).toLocaleString()}</b> (T·ªïng: ${Number(
          kqGop.tongTien
        ).toLocaleString()} VNƒê)</div>
        `;
      }

      ["savingName", "amount", "term", "interestRate"].forEach((n) => {
        const el = document.querySelector(`[name="${n}"]`);
        if (el) el.addEventListener("input", updateInterestPreview);
        if (el && n === "term")
          el.addEventListener("change", updateInterestPreview);
      });
    </script>
  </body>
</html>

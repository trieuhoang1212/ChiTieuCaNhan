<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Giao D·ªãch - Qu·∫£n l√Ω chi ti√™u</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="" name="keywords" />
    <meta content="" name="description" />

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon" />

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap"
      rel="stylesheet" />
    <!-- Icon Font Stylesheet -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
      rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
      rel="stylesheet" />

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet" />
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />
  </head>

  <body>
    <div class="container-xxl bg-white p-0">
      <!-- Spinner Start -->
      <div
        id="spinner"
        class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div
          class="spinner-border text-primary"
          style="width: 4rem; height: 4rem"
          role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
      <!-- Spinner End -->

      <!-- Navbar & Hero Start -->
      <div class="container-xxl position-relative p-0">
        <nav
          class="navbar navbar-expand-lg navbar-light px-4 px-lg-5 py-3 py-lg-0">
          <a href="index.html" class="navbar-brand p-0">
            <h1 class="m-0">MoneyCare</h1>
            <!-- <img src="img/logo.png" alt="Logo"> -->
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarCollapse">
            <span class="fa fa-bars"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto py-0">
              <a href="index.html" class="nav-item nav-link">Chung</a>
              <a href="NapRut.html" class="nav-item nav-link">N·∫°p/R√∫t</a>
              <a href="ChiTieu.html" class="nav-item nav-link">Chi Ti√™u</a>

              <div class="nav-item dropdown">
                <a
                  href="#"
                  class="nav-link dropdown-toggle"
                  data-bs-toggle="dropdown"
                  >M·ª•c</a
                >
                <div class="dropdown-menu m-0">
                  <a href="TichLuy.html" class="dropdown-item">T√≠ch Lu·ªπ</a>
                  <a href="ThuChi.html" class="dropdown-item active">Giao D·ªãch</a>
                  <a href="VayNo.html" class="dropdown-item">Vay N·ª£</a>
                  <a href="TietKiem.html" class="dropdown-item">Ti·∫øt Ki·ªám</a>
                </div>
              </div>
              <a href="Admin\template\index.html" class="nav-item nav-link"
                >Admin</a
              >
              <div class="nav-item dropdown" id="loginMenu">
                <a href="DangNhap.html" class="nav-item nav-link" id="loginLink"
                  >ƒêƒÉng Nh·∫≠p</a
                >
                <ul
                  class="dropdown-menu dropdown-menu-end"
                  aria-labelledby="loginLink"
                  id="userDropdown">
                  <li>
                    <a class="dropdown-item" href="ThongTin.html"
                      >üë§ Th√¥ng tin</a
                    >
                  </li>
                  <li>
                    <a
                      class="dropdown-item"
                      href="index.html"
                      onclick="logout()"
                      >üö™ ƒêƒÉng xu·∫•t</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </nav>

        <div class="container-xxl bg-primary page-header">
          <div class="container text-center">
            <h1 class="text-white animated zoomIn mb-3">Giao D·ªãch</h1>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb justify-content-center">
                <li class="breadcrumb-item">
                  <a class="text-white" href="#">Chung</a>
                </li>
                <li class="breadcrumb-item">
                  <a class="text-white" href="#">Trang</a>
                </li>
                <li
                  class="breadcrumb-item text-white active"
                  aria-current="page">
                  Giao D·ªãch
                </li>
              </ol>
            </nav>
          </div>
        </div>
      </div>

      <!-- Qu·∫£n l√Ω giao d·ªãch -->
      <div class="container py-5">
        <h2 class="mb-4">Qu·∫£n l√Ω Giao D·ªãch</h2>

        <!-- S·ªë d∆∞ -->
        <div class="alert alert-info">
          üí∞ S·ªë d∆∞ hi·ªán c√≥: <strong id="currentBalance">0 VNƒê</strong>
        </div>

        <!-- Form th√™m giao d·ªãch -->
        <div class="card p-3 mb-4">
          <form id="transactionForm" class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Lo·∫°i</label>
              <select class="form-control" name="type" required>
                <option value="income">Thu</option>
                <option value="expense">Chi</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">S·ªë ti·ªÅn (VNƒê)</label>
              <input
                type="number"
                class="form-control"
                name="amount"
                min="1000"
                required />
            </div>
            <div class="col-md-3">
              <label class="form-label">Ng√†y</label>
              <input type="date" class="form-control" name="date" required />
            </div>
            <div class="col-md-3">
              <label class="form-label">M√¥ t·∫£</label>
              <input type="text" class="form-control" name="note" />
            </div>

            <hr />

            <!-- Ng∆∞·ªùi giao d·ªãch -->
            <h5>Ng∆∞·ªùi giao d·ªãch</h5>

            <div class="col-md-4">
              <label class="form-label">Ch·ªçn t·ª´ danh b·∫°</label>
              <select class="form-control" id="contactSelect">
                <option value="">-- Ch·ªçn ng∆∞·ªùi ƒë√£ l∆∞u --</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">H·ªç t√™n</label>
              <input
                type="text"
                class="form-control"
                name="fullname"
                required />
            </div>

            <div class="col-md-4">
              <label class="form-label">S·ªë t√†i kho·∫£n</label>
              <input type="text" class="form-control" name="account" required />
            </div>

            <div class="col-md-4">
              <label class="form-label">Ng√¢n h√†ng</label>
              <select class="form-control" name="bank" required>
                <option value="">-- Ch·ªçn ng√¢n h√†ng --</option>
                <option value="Vietcombank">Vietcombank</option>
                <option value="VietinBank">VietinBank</option>
                <option value="BIDV">BIDV</option>
                <option value="Agribank">Agribank</option>
                <option value="Techcombank">Techcombank</option>
                <option value="ACB">ACB</option>
                <option value="Sacombank">Sacombank</option>
                <option value="MB Bank">MB Bank</option>
                <option value="TPBank">TPBank</option>
                <option value="VPBank">VPBank</option>
              </select>
            </div>

            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="saveContact"
                  id="saveContact" />
                <label class="form-check-label" for="saveContact"
                  >L∆∞u v√†o danh b·∫°</label
                >
              </div>
            </div>

            <div class="col-12">
              <button type="submit" class="btn btn-success">
                Th√™m giao d·ªãch
              </button>
            </div>
          </form>
        </div>

        <!-- Danh s√°ch giao d·ªãch -->
        <h4>L·ªãch s·ª≠ giao d·ªãch</h4>
        <div id="transactionsList" class="mb-5"></div>

        <!-- Qu·∫£n l√Ω danh b·∫° -->
        <h4>Danh b·∫° ng∆∞·ªùi giao d·ªãch</h4>
        <div id="contactsList"></div>
      </div>

      <!-- JavaScript Libraries -->
      <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
      <script src="lib/wow/wow.min.js"></script>
      <script src="lib/easing/easing.min.js"></script>
      <script src="lib/waypoints/waypoints.min.js"></script>
      <script src="lib/owlcarousel/owl.carousel.min.js"></script>
      <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

      <!-- Template Javascript -->
      <script src="js/main.js"></script>

      <script>
        let balance = 0;
        let transactions = [];
        let contacts = [];

        async function fetchCurrentBalance() {
          try {
            const response = await fetch("PHP/naprut.php?balanceOnly=1");
            const data = await response.json();
            if (data.success) {
              balance = data.currentBalance;
              document.getElementById("currentBalance").textContent =
                balance.toLocaleString() + " VNƒê";
            } else {
              console.error("Failed to fetch balance:", data.message);
            }
          } catch (error) {
            console.error("Error fetching balance:", error);
          }
        }

        document.addEventListener("DOMContentLoaded", () => {
          fetchCurrentBalance();

          // l·∫•y giao d·ªãch ƒë√£ l∆∞u
          const saved = localStorage.getItem("transactions");
          if (saved) transactions = JSON.parse(saved);

          // l·∫•y danh b·∫°
          const savedContacts = localStorage.getItem("contacts");
          if (savedContacts) contacts = JSON.parse(savedContacts);

          renderTransactions();
          renderContacts();
        });

        // Render danh b·∫° v√†o dropdown + danh s√°ch
        function renderContacts() {
          // dropdown
          const select = document.getElementById("contactSelect");
          select.innerHTML =
            '<option value="">-- Ch·ªçn ng∆∞·ªùi ƒë√£ l∆∞u --</option>';
          contacts.forEach((c, i) => {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = `${c.fullname} - ${c.bank}`;
            select.appendChild(opt);
          });

          select.addEventListener("change", (e) => {
            const idx = e.target.value;
            if (idx !== "") {
              const c = contacts[idx];
              document.querySelector("[name=fullname]").value = c.fullname;
              document.querySelector("[name=account]").value = c.account;
              document.querySelector("[name=bank]").value = c.bank;
            }
          });

          // danh s√°ch qu·∫£n l√Ω
          const container = document.getElementById("contactsList");
          container.innerHTML = "";
          if (contacts.length === 0) {
            container.innerHTML = "<p>Ch∆∞a c√≥ ng∆∞·ªùi n√†o trong danh b·∫°.</p>";
            return;
          }

          contacts.forEach((c, i) => {
            const card = document.createElement("div");
            card.className = "card p-3 mb-2";
            card.innerHTML = `
            <p><strong>${c.fullname}</strong> - ${c.account} (${c.bank})</p>
            <button class="btn btn-sm btn-danger" onclick="deleteContact(${i})">‚ùå Xo√° kh·ªèi danh b·∫°</button>
          `;
            container.appendChild(card);
          });
        }

        // Xo√° ng∆∞·ªùi kh·ªèi danh b·∫°
        function deleteContact(index) {
          if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° ng∆∞·ªùi n√†y kh·ªèi danh b·∫°?")) {
            contacts.splice(index, 1);
            localStorage.setItem("contacts", JSON.stringify(contacts));
            renderContacts();
          }
        }

        // Th√™m giao d·ªãch
        document
          .getElementById("transactionForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            const form = e.target;
            const type = form.type.value;
            const amount = parseInt(form.amount.value);
            const date = form.date.value;
            const note = form.note.value;
            const fullname = form.fullname.value;
            const account = form.account.value;
            const bank = form.bank.value;
            const saveContact = form.saveContact.checked;

            if (!amount || amount <= 0) {
              alert("‚ùå S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá!");
              return;
            }

            if (type === "expense" && amount > balance) {
              alert("‚ùå S·ªë d∆∞ kh√¥ng ƒë·ªß ƒë·ªÉ chi!");
              return;
            }

            const transaction = {
              id: Date.now(),
              type,
              amount,
              date,
              note,
              fullname,
              account,
              bank,
            };
            transactions.push(transaction);

            // l∆∞u danh b·∫° n·∫øu tick ch·ªçn
            if (saveContact) {
              contacts.push({ fullname, account, bank });
              localStorage.setItem("contacts", JSON.stringify(contacts));
              renderContacts();
            }

            // c·∫≠p nh·∫≠t s·ªë d∆∞ ch·ªâ khi lo·∫°i giao d·ªãch l√† "Chi"
            if (type === "expense") {
              balance -= amount;
              localStorage.setItem("balance", balance);
              document.getElementById("currentBalance").textContent =
                balance.toLocaleString() + " VNƒê";
            }

            localStorage.setItem("transactions", JSON.stringify(transactions));

            renderTransactions();
            form.reset();
          });

        // Xo√° giao d·ªãch
        function deleteTransaction(id) {
          const t = transactions.find((x) => x.id === id);
          if (!t) return;

          if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° giao d·ªãch n√†y?")) {
            // xo√° giao d·ªãch m√† kh√¥ng thay ƒë·ªïi s·ªë d∆∞
            transactions = transactions.filter((x) => x.id !== id);
            localStorage.setItem("transactions", JSON.stringify(transactions));

            renderTransactions();
          }
        }

        // Hi·ªÉn th·ªã danh s√°ch giao d·ªãch
        function renderTransactions() {
          const container = document.getElementById("transactionsList");
          container.innerHTML = "";

          if (transactions.length === 0) {
            container.innerHTML = "<p>Ch∆∞a c√≥ giao d·ªãch n√†o.</p>";
            return;
          }

          transactions
            .slice()
            .reverse()
            .forEach((t) => {
              const card = document.createElement("div");
              card.className =
                "card p-3 mb-2 border-" +
                (t.type === "income" ? "success" : "danger");

              let cardContent = `
          <p><strong>${
            t.type === "income" ? "‚ûï Thu" : "‚ûñ Chi"
          }</strong> - ${t.amount.toLocaleString()} VNƒê</p>
          <p><strong>Ng√†y:</strong> ${t.date}</p>
          <p><strong>M√¥ t·∫£:</strong> ${t.note || "(kh√¥ng)"} </p>
          <p><strong>Ng∆∞·ªùi giao d·ªãch:</strong> ${t.fullname} - ${
          t.account
        } (${t.bank})</p>
          <button class="btn btn-sm btn-danger" onclick="deleteTransaction(${t.id})">üóëÔ∏è Xo√° giao d·ªãch</button>
        `;

              if (t.type === "income") {
                cardContent += `
            <div class="text-center mt-3">
              <img src="img/qr.png" alt="QR Code" width="128" height="128" onclick="openModal(this.src)" style="cursor: pointer;" />
              <small class="text-muted">Qu√©t m√£ QR ƒë·ªÉ nh·∫≠n ti·ªÅn</small>
            </div>
          `;
              }

              card.innerHTML = cardContent;
              container.appendChild(card);
            });
        }

        function openModal(src) {
          const modal = document.getElementById("qrModal");
          const modalImage = document.getElementById("modalImage");
          modalImage.src = src;
          modal.style.display = "block";
        }

        function closeModal() {
          const modal = document.getElementById("qrModal");
          modal.style.display = "none";
        }
      </script>

      <style>
        /* Modal styles */
        #qrModal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgba(0, 0, 0, 0.8);
        }

        #qrModal img {
          margin: auto;
          display: block;
          max-width: 90%;
          max-height: 90%;
        }

        #qrModal .close {
          position: absolute;
          top: 10px;
          right: 20px;
          color: white;
          font-size: 30px;
          font-weight: bold;
          cursor: pointer;
        }
      </style>

      <div id="qrModal">
        <span class="close" onclick="closeModal()">&times;</span>
        <img id="modalImage" src="" alt="QR Code" />
      </div>

      <script src="js/navbar.js"></script>
    </div>
  </body>
</html>
